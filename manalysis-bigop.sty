\ProvidesExplFile
{manalysis-bigop.sty} {2025/07/03} {0.1}
{A~module~for~regex~powered~frac~command}

\fp_new:N \g__manalysis_big_operator_padding_up_fp
\fp_new:N \g__manalysis_big_operator_padding_down_fp
\tl_new:N \g__manalysis_big_operator_ref_symbol_tl

\fp_set:Nn \g__manalysis_big_operator_padding_up_fp { 0 }
\fp_set:Nn \g__manalysis_big_operator_padding_down_fp { 0 }
\tl_set:Nn \g__manalysis_big_operator_ref_symbol_tl { \sum }

\keys_define:nn { hanalysis / bigop } {
	padding-up   .fp_set:N = \g__manalysis_big_operator_padding_up_fp,
	padding-down .fp_set:N = \g__manalysis_big_operator_padding_down_fp,
	ref-symbol	 .tl_set:N = \g__manalysis_big_operator_ref_symbol_tl
}

\cs_new:Nn \__manalysis_big_operator:nnnnn {
	\hbox_set:Nn \l_tmpb_box { $ #4#3 $ }
	\hbox_set:Nn \l_tmpa_box { $ #4#5 $ }
	\fp_set:Nn \l_tmpa_fp {
		\l__manalysis_tmpa_fp *
		\dim_ratio:nn { \box_ht:N \l_tmpb_box + \box_dp:N \l_tmpb_box } { \box_ht:N \l_tmpa_box + \box_dp:N \l_tmpa_box }
	}
	\box_scale:Nnn { \l_tmpa_box } { \l_tmpa_fp } { \l_tmpa_fp }
	\hbox_set:Nn \l__manalysis_tmpa_box {
		\box_move_up:nn
		{
			\box_dp:N \l_tmpa_box
			- \box_dp:N \l_tmpb_box +
			\fp_use:N \l__manalysis_tmpb_fp \box_dp:N \l_tmpb_box +
			\fp_use:N \l__manalysis_tmpb_fp \box_ht:N \l_tmpb_box
		} {
			\box_use:N \l_tmpa_box
		}
	}
}

\cs_new:Nn \__manalysis_big_operator_star:nnnnn {
	\__manalysis_big_operator:nnnnn { #1 } { #2 } { #3 } { #4 } { #5 }
	\box_set_ht:Nn \l__manalysis_tmpa_box { \box_ht:N \l_tmpb_box - #1 \box_ht:N \l_tmpb_box - #1 \box_dp:N \l_tmpb_box }
	\box_set_dp:Nn \l__manalysis_tmpa_box { \box_dp:N \l_tmpb_box - #2 \box_ht:N \l_tmpb_box - #2 \box_dp:N \l_tmpb_box }
	\tex_mathop:D { \box_use:N \l__manalysis_tmpa_box }
}

\cs_new:Nn \__manalysis_big_operator_no_star:nnnnn {
	\__manalysis_big_operator:nnnnn { #1 } { #2 } { #3 } { #4 } { #5 }
	\box_set_ht:Nn \l__manalysis_tmpa_box { \box_ht:N \l_tmpb_box }
	\box_set_dp:Nn \l__manalysis_tmpa_box { \box_dp:N \l_tmpb_box }
	\tex_mathop:D { \box_use:N \l__manalysis_tmpa_box }
}

\cs_new:Nn \__manalysis_bigop_mathpalette_no_star:nnnn {
	\tex_mathop:D {
		\__manalysis_mathpalette:nn { \__manalysis_big_operator_no_star:nnnnn { #1 } { #2 } { #3 } } { #4 }
	}
}

\cs_new:Nn \__manalysis_bigop_fuzzy_star:nnnnn {
	\hbox_set:Nn \l_tmpb_box { $ #4#3 $ }
	\hbox_set:Nn \l_tmpa_box { }
	\box_set_ht:Nn \l_tmpa_box { \box_ht:N \l_tmpb_box - #1 \box_ht:N \l_tmpb_box - #1 \box_dp:N \l_tmpb_box }
	\box_set_dp:Nn \l_tmpa_box { \box_dp:N \l_tmpb_box - #2 \box_ht:N \l_tmpb_box - #2 \box_dp:N \l_tmpb_box }
	\box_use:N \l_tmpa_box
}

% \NewDocumentCommand { \bigop } {
% 	s O{\fp_use:N \g__manalysis_big_operator_padding_up_fp}
% 	O{\fp_use:N \g__manalysis_big_operator_padding_down_fp}
% 	m O{\tl_use:N \g__manalysis_big_operator_ref_symbol_tl}
% } {
% 	\fp_set:Nn \l__manalysis_tmpa_fp { 1 - #3 - #2 }
% 	\fp_set:Nn \l__manalysis_tmpb_fp { \fp_min:nn { 1 - #2 } { #3 } }
% 	\IfBooleanTF { #1 } {
% 		\tex_mathop:D {
% 			\__manalysis_mathpalette:nn { \__manalysis_big_operator_star:nnnnn { #2 } { #3 } { #5 } } { #4 }
% 		}
% 	} {
% 		\__manalysis_bigop_mathpalette_no_star:nnnn { #2 } { #3 } { #5 } { #4 }
% 	}
% }


\NewDocumentCommand { \bigop } {
	s o
	o
	m O{ \sum }
} {
	\IfNoValueTF{ #2 }{
		\fp_set:Nn \l__manalysis_tmpa_fp { 1 - \g__manalysis_big_operator_padding_up_fp - \g__manalysis_big_operator_padding_down_fp }
		\fp_set:Nn \l__manalysis_tmpb_fp { \fp_min:nn { 1 - \g__manalysis_big_operator_padding_up_fp } { \g__manalysis_big_operator_padding_down_fp } }
	} {
		\IfNoValueTF{ #3 }{
			\fp_set:Nn \l__manalysis_tmpa_fp { 1 - #2 - \g__manalysis_big_operator_padding_down_fp }
			\fp_set:Nn \l__manalysis_tmpb_fp { \fp_min:nn { 1 - #2 } { \g__manalysis_big_operator_padding_down_fp } }
		} {
			\fp_set:Nn \l__manalysis_tmpa_fp { 1 - #3 - #2 }
			\fp_set:Nn \l__manalysis_tmpb_fp { \fp_min:nn { 1 - #2 } { #3 } }
		}
	}
	\IfBooleanTF { #1 } {
		\tex_mathop:D {
			\__manalysis_mathpalette:nn { \__manalysis_big_operator_star:nnnnn { #2 } { #3 } { #5 } } { #4 }
		}
	} {
		\__manalysis_bigop_mathpalette_no_star:nnnn { #2 } { #3 } { #5 } { #4 }
	}
}

