\ProvidesExplFile
{manalysis-accent.sty} {2025/07/03} {0.1}
{Auxiliary~module~for~automatically~adjusting~the~width~of~accents~in~formulas}

\dim_new:N \g__manalysis_accent_threshold_wd_high_dim
\dim_new:N \g__manalysis_accent_threshold_wd_low_dim
\dim_new:N \g__manalysis_accent_threshold_ht_dim
\bool_new:N \g__manalysis_accent_enable_threshold_ht_bool
\fp_new:N \g__manalysis_accnet_pre_font_size

\dim_set:Nn \g__manalysis_accent_threshold_wd_high_dim { 1.3 em }
\dim_set:Nn \g__manalysis_accent_threshold_wd_low_dim { 0.8 em }
\dim_set:Nn \g__manalysis_accent_threshold_ht_dim { 2 ex }
\fp_set:Nn \g__manalysis_accnet_pre_font_size { \f@size }


\keys_define:nn { manalysis / accent } {
	threshold-high      .dim_set:N  = \g__manalysis_accent_threshold_wd_high_dim,
	threshold-low       .dim_set:N  = \g__manalysis_accent_threshold_wd_low_dim,
	threshold-ht        .dim_set:N  = \g__manalysis_accent_threshold_ht_dim,
	enable-threshold-ht .bool_set:N = \g__manalysis_accent_enable_threshold_ht_bool
}


\NewDocumentCommand { \DeclareAccent } { m m m o O { } O { } } {
	\cs_if_exist:cTF { __manalysis_ \cs_to_str:N #1: } { } {
		\cs_new:cn { __manalysis_ \cs_to_str:N #1: } {
			\__manalysis_mathchoice:nnnn {
				\fontsize{ \fp_eval:n { \f@size^2 / \sf@size } } { 0 pt } \selectfont
				\box_move_down:nn { 1ex } { \hbox:n { $ \tex_displaystyle:D #2 { \hbox_to_wd:nn { 1 ex } { } } $ } }
			} {
				\fontsize{ \fp_eval:n { \f@size^2 / \sf@size } } { 0 pt } \selectfont
				\box_move_down:nn { 1ex } { \hbox:n { $ \tex_displaystyle:D #2 { \hbox_to_wd:nn { 1 ex } { } } $ } }
			} {
				\box_move_down:nn { 1ex } { \hbox:n { $ \tex_displaystyle:D #2 { \hbox_to_wd:nn { \fp_eval:n { \sf@size / \f@size } ex } { } } $ } }
			} {
				\box_move_down:nn { 1ex } { \hbox:n { $ \tex_scriptstyle:D #2 { \hbox_to_wd:nn { \fp_eval:n { \ssf@size / \f@size } ex } { } } $ } }
			}
		}
	}
	\DeclareDocumentCommand { #1 } { o m O { } } {
		\hbox_set:Nn \l_tmpa_box { $ ##2 $ }
		\dim_set:Nn \l_tmpa_dim { \fp_eval:n { \g__manalysis_accnet_pre_font_size / \f@size } \box_wd:N \l_tmpa_box }
		\bool_if:NTF \g__manalysis_accent_enable_threshold_ht_bool {
			\dim_set:Nn \l_tmpb_dim { \fp_eval:n { \g__manalysis_accnet_pre_font_size / \f@size } \box_ht:N \l_tmpa_box }
		} { \dim_set_eq:NN \l_tmpb_dim \c_zero_dim }
		\IfNoValueTF { ##1 } {
			\dim_compare:nNnTF \l_tmpb_dim > \g__manalysis_accent_threshold_ht_dim { 
				\IfNoValueTF { #4 }
				{ \tex_left:D ( ##2 \tex_right:D ) ^ { #5 \use:c { __manalysis_ \cs_to_str:N #1 : } ##3 #6 } }
				{ #4 { ##2 } ^ { #5 \use:c { __manalysis_ \cs_to_str:N #1 : } ##3 #6 } }
			} {
				\dim_compare:nNnTF \l_tmpa_dim > \g__manalysis_accent_threshold_wd_low_dim {
				\dim_compare:nNnTF \l_tmpa_dim > \g__manalysis_accent_threshold_wd_high_dim {
					\IfNoValueTF { #4 }
						{ \tex_left:D ( ##2 \tex_right:D ) ^ { #5 \use:c { __manalysis_ \cs_to_str:N #1 : } ##3 #6 } }
						{ #4 { ##2 } ^ { #5 \use:c { __manalysis_ \cs_to_str:N #1 : } ##3 #6 } }
					} { #3 { ##2 } }
				} { #2 { ##2 } }
			}
		} { ##1 { ##2 } ^ { #5 \use:c { __manalysis_ \cs_to_str:N #1 : } ##3 #6 } }
	}
	\tl_put_right:Nn \g__manalysis_accent_relax { #1 }
}

